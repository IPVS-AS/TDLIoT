<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="lib/css/bootstrap.min.css" ></link>
	
	<script src="lib/js/jquery-3.2.1.min.js"></script>
	<script src="lib/js/bootstrap.min.js"></script>
	<script src="lib/js/angular.min.js"></script>
	<title>Topic Description Catalogue</title>
</head>
<body>
<div ng-app="tdlApp" ng-controller="tdlCtrl">
	<div class="jumbotron jumbotron-fluid text-center" style="padding: 10px">
	  <h1>Topic Description Catalogue</h1>
	</div>
<div class="container-fluid">
<div class="row">
	<div class="col-sm-4"></div>
	<div class="col-sm-4">
		<h1>Jump to</h1>
		<div class="list-group">
			<a class="list-group-item list-group-item-action" href="#descriptions">Topic descriptions</a>
			<a class="list-group-item list-group-item-action" href="#adddescription">Add topic description</a>
			<a class="list-group-item list-group-item-action" href="#settings">Settings</a>
		</div>
	</div>	
	<div class="col-sm-4"></div>
</div>
<div class="row rowborder"></div>
<div class="row">
	<div class="col-sm-1"></div>
	<div class="col-sm-10">
		<h1 id="descriptions">Topic descriptions</h1>
		<p>All available topic descriptions which are matching to the provided filter values.</p>
		<table class="table table-bordered">
			<tr style="background-color: #EEE">
				<th ng-show="showId">
					id
					</br>
					<label><input ng-model="searchText._id.$oid"></label>
				</th>
				<th ng-show="showDataType">
					data_type
					</br>
					<label><input ng-model="searchText.data_type"></label>
				</th>
				<th ng-show="showHardwareType">
					hardware_type
					</br>
					<label><input ng-model="searchText.hardware_type"></label>
				</th>
				<th ng-show="showTopicType">
					topic_type
					</br>
					<label><input ng-model="searchText.topic_type"></label>
				</th>
				<th ng-show="showMessageFormat">
					message_format
					</br>
					<label><input ng-model="searchText.message_format"></label>
				</th>
				<th ng-show="showProtocol">
					protocol
					</br>
					<label><input ng-model="searchText.protocol"></label>
				</th>
				<th ng-show="showOwner">
					owner
					</br>
					<label><input ng-model="searchText.owner"></label>
				</th>
				<th ng-show="showMiddlewareEndpoint">
					middleware_endpoint
					</br>
					<label><input ng-model="searchText.middleware_endpoint"></label>
				</th>
				<th ng-show="showPath">
					path
					</br>
					<label><input ng-model="searchText.path"></label>
				</th>
				<th colspan="3" style="text-align: center">
					Events
				</th>
			</tr>
			<tr ng-repeat="topic in topicDescription | filter:searchText">
				<td ng-if="showId">{{topic._id.$oid}}
				</td>
				<td ng-if="showDataType">
					<div ng-hide="updateMode">{{topic.data_type}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.data_type"></label></div>
				</td>
				<td ng-if="showHardwareType">
					<div ng-hide="updateMode">{{topic.hardware_type}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.hardware_type"></label></div>
				</td>
				<td ng-if="showTopicType">
					<div ng-hide="updateMode">{{topic.topic_type}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.topic_type"></label></div>
				</td>
				<td ng-if="showMessageFormat">
					<div ng-hide="updateMode">{{topic.message_format}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.message_format"></label></div>
				</td>
				<td ng-if="showProtocol">
					<div ng-hide="updateMode">{{topic.protocol}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.protocol"></label></div>
				</td>
				<td ng-if="showOwner">
					<div ng-hide="updateMode">{{topic.owner}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.owner"></label></div>
				</td>
				<td ng-if="showMiddlewareEndpoint">
					<div ng-hide="updateMode">{{topic.middleware_endpoint}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.middleware_endpoint"></label></div>
				</td>
				<td ng-if="showPath">
					<div ng-hide="updateMode">{{topic.path}}</div>
					<div ng-show="updateMode"><label><input ng-model="topic.path"></label></div>
				</td>
				<td class="borderless">
					<a type="button" data-toggle="collapse" data-target="#complete_{{topic._id.$oid}}" class="btn btn-primary">Show JSON</a>
					<div id="complete_{{topic._id.$oid}}" class="collapse">
						<pre>{{topic | json}}</pre>
					</div>
				</td>
				<td ng-hide="updateMode" class="borderless">
					<button type="button" class="btn btn-success" ng-click="updateMode=true">Update</button>
				</td>
				<td ng-show="updateMode" class="borderless">
					<button type="button" class="btn btn-success" ng-click="updateMode=false; updateTopicDescription(topic)" >Save</button>
				</td>
				<td ng-show="updateMode" class="borderless">
					<button type="button" class="btn btn-warning" ng-click="updateMode=false; cancelUpdateTopicDescription(topic)">Cancel</button>
				</td>
				<td ng-hide="updateMode" class="borderless">
					<a type="button" ng-click="removeTopicDescription(topic)" class="btn btn-danger">Delete</a>
				</td>
			</tr>
		</table>
	</div>
	<div class="col-sm-1"></div>
</div>
<div class="row rowborder"></div>
<div class="row">
	<div class="col-sm-4"></div>
	<div class="col-sm-4">
		<h1 id="adddescription">Add topic description</h1>	
		Add topic description to catalogue.
				<table class="table table-bordered">
			<tr style="background-color: #EEE">
				<th>Property</th>
				<th>Value</th>
			</tr>			
			<tr>
				<th>data_type</th>
				<td>
					<label><input ng-model="insert.data_type"></label>
				</td>
			</tr>
			<tr>
				<th>hardware_type</th>
				<td>
					<label><input ng-model="insert.hardware_type"></label>
				</td>				
			</tr>
			<tr>
				<th>topic_type</th>
				<td>
					<label><input ng-model="insert.topic_type"></label>
				</td>				
			</tr>
			<tr>
				<th>message_format</th>
				<td>
					<label><input ng-model="insert.message_format"></label>
				</td>				
			</tr>
			<tr>
				<th>protocol</th>
				<td>
					<label><input ng-model="insert.protocol"></label>
				</td>				
			</tr>
			<tr>
				<th>owner</th>
				<td>
					<label><input ng-model="insert.owner"></label>
				</td>				
			</tr>
			<tr>
				<th>middleware_endpoint</th>
				<td>
					<label><input ng-model="insert.middleware_endpoint"></label>
				</td>				
			</tr>
			<tr>
				<th>path</th>
				<td>
					<label><input ng-model="insert.path"></label>
				</td>				
			</tr>		
		</table>
		<button type="button" class="btn btn-primary" ng-click="insertTopicDescription()">Insert</button>
		<button type="button" class="btn btn-warning" ng-click="cancelInsertTopicDescription()">Cancel</button>
		<br/>
		<div ng-if="idOfNewTopicDescription">
			<br/>
			<pre>{{idOfNewTopicDescription}}</pre> is the new id of the topic description from <span>{{addDate | date:'dd/MM/yyyy HH:mm:ss'}}</span>
		</div>
	</div>
	<div class="col-sm-4"></div>
</div>
<div class="row rowborder"></div>
<div class="row">
	<div class="col-sm-4"></div>
	<div class="col-sm-4">
		<h1 id="settings">Settings</h1>		
		<p>Show this columns in upper table:</p>
		<p class="btn-info">Filter value is always active also when the column is not visible!</p>
		<table class="table table-bordered">
			<tr style="background-color: #EEE">
				<th>
					Property
				</th>
				<th>
					Filter value
				</th>
			</tr>
			<tr>
				<td>
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showId" ng-init="showId = true"></input> 
							id
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText._id.$oid"></label>
				</td>
			</tr>
			
			<tr>
				<td>
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showDataType" ng-init="showDataType = true"></input> 
							data_type
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.data_type"></label>
				</td>
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showHardwareType" ng-init="showHardwareType = true"></input> 
							hardware_type
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.hardware_type"></label>
				</td>				
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showTopicType" ng-init="showTopicType = false"></input> 
							topic_type
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.topic_type"></label>
				</td>				
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showMessageFormat" ng-init="showMessageFormat = false"></input> 
							message_format
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.message_format"></label>
				</td>				
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showProtocol" ng-init="showProtocol = true"></input> 
							protocol
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.protocol"></label>
				</td>				
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showOwner" ng-init="showOwner = true"></input> 
							owner
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.owner"></label>
				</td>				
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showMiddlewareEndpoint" ng-init="showMiddlewareEndpoint = false"></input> 
							middleware_endpoint
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.middleware_endpoint"></label>
				</td>				
			</tr>
			<tr>
				<td>			
					<div class="form-check">
						<label class="form-check-label">
							<input class="form-check-input" type="checkbox" ng-model="showPath" ng-init="showPath = false"></input> 
							path
						</label>
					</div>
				</td>
				<td>
					<label><input ng-model="searchText.path"></label>
				</td>				
			</tr>		
		</table>
	</div>	
	<div class="col-sm-4"></div>	
</div>
</div>
</div>

<script>

var app = angular.module('tdlApp', []);
app.controller('tdlCtrl', function($scope, $http) {
	
	$scope.topicDescriptionProperties = [
	                  "data_type",
	                  "hardware_type",
	                  "topic_type",
	                  "message_format",
	                  "protocol",
	                  "owner",
	                  "middleware_endpoint",
	                  "path"
	              ]
	
    var url = "http://localhost:8080/catalogue";

	$http({
    	method: 'POST', 
    	url: url + "/search",
    	data: { filters: {}},
    	headers: { "Content-Type": "application/json" }
    }).then(function(response) {
    	$scope.status = response.status;  
    	
    	$scope.topicDescription = [];
    	//$scope.backUpTopicDescription = [];
    	for(var i in response.data){
    		var elementData = response.data[i];
    		$scope.topicDescription.push(angular.fromJson(elementData)); 
    	//	$scope.backUpTopicDescription.push(angular.fromJson(elementData))
    	}   
    	
    	$scope.backUpTopicDescription = JSON.parse(JSON.stringify($scope.topicDescription));
    	
    }, function(response) {
        $scope.data = response.data || 'Request failed';
        $scope.status = response.status;
    });
	
	$scope.removeTopicDescription = function(topic) {
        $scope.response = null;

        $http({
        	method: 'DELETE', 
        	url: url + "/delete/" + topic._id.$oid
        }).then(function(response) {
	    	$scope.status = response.status;
   			for(var i in $scope.topicDescription){
   				if($scope.topicDescription[i]._id.$oid == topic._id.$oid){
   					$scope.topicDescription.splice(i, 1);
   					$scope.backUpTopicDescription.splice(i, 1);
   					break;
   				}
	    	} 
	    }, function(response) {
	        $scope.data = response.data || 'Request failed';
	        $scope.status = response.status;
	    });
	};
	
	$scope.cancelUpdateTopicDescription = function(topic) {      
        for(var i in $scope.backUpTopicDescription){
			if($scope.backUpTopicDescription[i]._id.$oid == topic._id.$oid){
				$scope.topicDescription[i] = JSON.parse(JSON.stringify($scope.backUpTopicDescription[i]));
				break;
			}
    	} 
	};
	
	$scope.updateTopicDescription = function(topic) {
        $scope.response = null;
        
        var updateBody = {};
        for(var key in topic){
        	if(key != "_id"){
            	updateBody[key] = topic[key];
        	}
        }
        
        for(var i in $scope.backUpTopicDescription){
			if($scope.backUpTopicDescription[i]._id.$oid == topic._id.$oid){
				$scope.backUpTopicDescription[i] = JSON.parse(JSON.stringify(topic));
				break;
			}
    	} 
        
    	$http({
        	method: 'PUT', 
        	url: url + "/update/" + topic._id.$oid,
        	data: updateBody,
        	headers: { "Content-Type": "application/json" }
    	}
        ).then(function(response) {
	    	$scope.status = response.status;
	    }, function(response) {
	        $scope.data = response.data || 'Request failed';
	        $scope.status = response.status;
	    });
	};
	
	$scope.cancelInsertTopicDescription = function() {      
		for(var property in $scope.insert){
        	$scope.insert[property] = "";
    	}   
	};
	
	$scope.insertTopicDescription = function() {
        $scope.response = null;
        
        var topicDescription = {};
        for(var property in $scope.insert){
        	var value = $scope.insert[property];
        	if(value != ""){
        		topicDescription[property] = value;
        	}
    	}     
        
        if($.isEmptyObject(topicDescription)){
        	alert('No values available! Please insert values.');
        	return;
        }

    	$http({
        	method: 'POST', 
        	url: url + "/add",
        	data: topicDescription,
        	headers: { "Content-Type": "text/plain" },
        	transformResponse: [function (data) {
       	      return data;
       	  }]
    	}
        ).then(function(response) {
	    	$scope.status = response.status;
	    	$scope.idOfNewTopicDescription = response.data;
	    	$scope.addDate = new Date();
	    	topicDescription["_id"] = {};
	        topicDescription["_id"]["$oid"] = $scope.idOfNewTopicDescription;
			$scope.topicDescription.push(topicDescription);
			$scope.backUpTopicDescription.push(topicDescription);
	    }, function(response) {
	        $scope.data = response.data || 'Request failed';
	        $scope.status = response.status;
	    });
	};
});
</script>
<style type="text/css">

	.borderless {
		border: 0 !important
	}
	
	.btn {
		min-width: 75px
	}
	
	.rowborder {
		background-color: #EEE;
		height: 50px;
		margin-top: 30px;
		margin-bottom: 20px;
	}
</style>

</body>
</html>